# Kirikiri Project Instructions for AI Agents

These instructions provide the necessary context and technical details for managing and developing the Kirikiri Grav CMS project.

## Project Context
- **Name**: Kirikiri (Online Magazine/Journal)
- **Status**: Migrated from Astro to Grav CMS (v1.7.x) in Dec 2025.
- **Goal**: A minimalist, high-typography editorial site with an easy-to-use admin panel.

## Technical Environment
- **CMS**: Grav CMS with Admin plugin.
- **Runtime**: PHP 8.3 (Required for latest Admin plugin stability).
- **Web Server**: Apache with `mod_rewrite` enabled.
- **Local Development**: Runs in a Docker container named `kirikiri-preview` (`php:8.3-apache`).
- **Critical File**: `.htaccess` must be in the webroot (`/var/www/html/`) for routing to work.

## Theme Architecture: "Kirikiri"
The theme is located at `user/themes/kirikiri`.

### 1. Typography & CSS
- **Font**: **Merriweather** (loaded via Google Fonts).
- **CSS Variable Based**: Primary styles are in `user/themes/kirikiri/css/custom.css`.
- **Card Design**: 
    - 0.5px black/dark border.
    - Sharp small gray shadow: `3px 3px 0px rgba(0, 0, 0, 0.1)`.
    - NO zoom effect on hover. Transition uses `translate`.
- **Single Post Header**: 
    - Side-by-side flex layout (`article-hero`).
    - Title/Meta on the left, Featured Image on the right.
    - Image height should match text box height.
    - Minimal top whitespace (`0.5rem` padding).

### 2. Templates (Twig)
- `base.html.twig`: Foundational layout.
- `home.html.twig` / `blog.html.twig`: Article grids.
- `item.html.twig`: Single post view (uses the side-by-side hero).

## Workflow & Common Commands
- **Clearing Cache**: ALWAYS clear Grav cache after CSS or template changes.
  ```bash
  echo "yes" | docker exec -i -u www-data kirikiri-preview bin/grav clearcache
  ```
- **Permissions**: If the Admin panel fails to save, fix permissions in the container:
  ```bash
  docker exec -u root kirikiri-preview chown -R www-data:www-data /var/www/html
  ```
- **File Edits**: If host-to-container sync is slow or failing, use `docker exec` with heredoc to write files directly into the container.

## Content Management
- Pages are in `user/pages/`.
- Blog posts are in `user/pages/02.blog/[post-slug]/item.md`.
- Featured images are specified in frontmatter: `header.image: filename.jpg`.

## Documentation for User
- `PROJEKTI_DOKUMENTATSIOON.md`: General overview and Estonian guide.
- `nuc_deployment_guide.md`: Steps for deploying to the NUC server.

## Admin Customization
### "Add Article" Modal
- **Configuration File**: `user/blueprints/admin/pages/new_post.yaml`
- **Purpose**: Defines the simplified creation form when adding a new post in the Admin panel.
- **Key Implementation Detail**: 
    - To prepopulate frontmatter fields (like `taxonomy`), you MUST prefix the field name with `header.`.
    - **Incorrect**: `taxonomy.tag` (will not save to page file).
    - **Correct**: `header.taxonomy.tag` (saves to `taxonomy: tag: [...]` in frontmatter).
- **Default Author**: Sets current user or a default string to `taxonomy.author`.

### Taxonomy & Metadata
- **Author Field**: 
    - Migrated from simple `header.author` (string) to `taxonomy.author` (list of strings).
    - This enables standard Grav filtering (e.g., `/blog/author:Name`).
    - **Blueprints**: Configured as `type: array` with `value_only: true` in `new_post.yaml` to ensure Grav saves it as a YAML list `['Name']` rather than a CSV string.
- **Template Logic**:
    - Templates (`blog.html.twig`, `home.html.twig`) use robust fallback logic to support both new and legacy data:
      1. Check `post.taxonomy.author` (iterable list).
      2. Check `post.header.taxonomy.author` (direct header access).
      3. Fallback to `post.header.author` (legacy string).
- **Plugins**: 
    - `taxonomylist` is required for the Authors page (`/authors`) to function and list all unique authors with counts.

## Git & Version Control
- **.gitignore**: Standard Grav patterns apply. Always ignore `cache/`, `logs/`, `tmp/`, `images/`, `assets/`, and `backup/` to prevent repository bloat.
- **Admin Plugin Updates**: 
    - The Admin panel may automatically update dependencies in `user/plugins/admin/vendor/`.
    - If `git status` shows many changes in `vendor/` after using the Admin panel, this is normal.
    - **Action**: Verify the site still works, then commit these changes with a maintenance message (e.g., `chore: Update admin plugin dependencies`).
