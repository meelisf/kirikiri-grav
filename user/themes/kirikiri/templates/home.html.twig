{% extends 'partials/base.html.twig' %}

{% block content %}
    {% set posts = page.collection() %}
    {% if posts|length == 0 %}
        {% set posts = page.find('/blog').children().order('date', 'desc') %}
    {% endif %}
    
    {# If filtering by tag or author, show simple grid (no featured) #}
    {% if uri.param('tag') or uri.param('author') %}
        {% if uri.param('tag') %}
            <h1 class="page-title">Teema: {{ uri.param('tag') }}</h1>
        {% elseif uri.param('author') %}
            <h1 class="page-title">Autor: {{ uri.param('author') }}</h1>
        {% endif %}
        
        <div class="post-grid">
            {% for post in posts %}
                <article class="card">
                    {% if post.header.image %}
                        <a href="{{ post.url }}" class="card-image-link">
                            <img src="{{ post.media[post.header.image].url }}" alt="{{ post.title }}" class="card-image">
                        </a>
                    {% endif %}
                    
                    <div class="card-content">
                        <div class="card-category">
                            {% for tag in post.taxonomy.tag %}
                                <a href="{{ base_url }}/blog/tag:{{ tag }}">{{ tag }}</a>{% if not loop.last %}, {% endif %}
                            {% else %}
                                Artikkel
                            {% endfor %}
                        </div>
                        <h3 class="card-title">
                            <a href="{{ post.url }}">{{ post.title }}</a>
                        </h3>
                        <div class="card-excerpt {{ post.title|length < 50 ? 'excerpt-long' : '' }}">
                            {% if post.title|length < 50 %}
                                {{ post.content|striptags|truncate(280, true, ' ...')|raw }}
                            {% else %}
                                {{ post.summary|striptags }}
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            {% set months = ["jaanuar", "veebruar", "märts", "aprill", "mai", "juuni", "juuli", "august", "september", "oktoober", "november", "detsember"] %}
                            <span class="card-date">{{ post.date|date("j.") }} {{ months[post.date|date("n") - 1] }} {{ post.date|date("Y") }}</span>
                            {% if post.taxonomy.author is iterable %}
                                {% set author = post.taxonomy.author|first %}
                            {% elseif post.header.taxonomy.author %}
                                {% set author = post.header.taxonomy.author|first %}
                            {% else %}
                                {% set author = post.header.author %}
                            {% endif %}
                            {% if author %}
                                <span class="card-author">
                                    <a href="{{ base_url }}/blog/author:{{ author|url_encode }}">{{ author }}</a>
                                </span>
                            {% endif %}
                        </div>
                        <a href="{{ post.url }}" class="read-more-link">Loe edasi →</a>
                    </div>
                </article>
            {% endfor %}
        </div>
        
        <div class="back-link">
            <a href="{{ base_url }}">← Tagasi esilehele</a>
        </div>
    {% else %}
        {# Normal homepage with featured article #}
        
        {# Find featured article - look for featured: true, fallback to first post #}
        {% set featured = null %}
        {% for post in posts %}
            {% if post.header.featured %}
                {% set featured = post %}
            {% endif %}
        {% endfor %}
        {% if not featured %}
            {% set featured = posts|first %}
        {% endif %}
    
    {# Featured Article #}
    {% if featured %}
        <div class="featured-section">
            <article class="featured-article card">
                {% if featured.header.featured %}
                    <span class="featured-badge">Esiletõstetud</span>
                {% endif %}
                {% if featured.header.image %}
                    <div class="featured-image">
                        <a href="{{ featured.url }}">
                            <img src="{{ featured.media[featured.header.image].url }}" alt="{{ featured.title }}">
                        </a>
                    </div>
                {% else %}
                    <div class="featured-image featured-placeholder">
                        <a href="{{ featured.url }}">
                            <span class="placeholder-icon">❦</span>
                        </a>
                    </div>
                {% endif %}
                <div class="featured-content">
                    <div class="card-category">
                        {% for tag in featured.taxonomy.tag %}
                            <a href="{{ base_url }}/blog/tag:{{ tag }}">{{ tag }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    <h2 class="featured-title">
                        <a href="{{ featured.url }}">{{ featured.title }}</a>
                    </h2>
                    <div class="featured-excerpt">
                        {{ featured.summary|striptags }}
                    </div>
                    <div class="featured-meta">
                        {% set months = ["jaanuar", "veebruar", "märts", "aprill", "mai", "juuni", "juuli", "august", "september", "oktoober", "november", "detsember"] %}
                        <span class="card-date">{{ featured.date|date("j.") }} {{ months[featured.date|date("n") - 1] }} {{ featured.date|date("Y") }}</span>
                        {% if featured.taxonomy.author is iterable %}
                            {% set author = featured.taxonomy.author|first %}
                        {% elseif featured.header.taxonomy.author %}
                            {% set author = featured.header.taxonomy.author|first %}
                        {% else %}
                            {% set author = featured.header.author %}
                        {% endif %}
                        {% if author %}
                            <span class="card-author">
                                <a href="{{ base_url }}/blog/author:{{ author|url_encode }}">{{ author }}</a>
                            </span>
                        {% endif %}
                    </div>
                    <a href="{{ featured.url }}" class="read-more-link">Loe edasi →</a>
                </div>
            </article>
        </div>
    {% endif %}

    {# Recent Posts Grid - Exclude featured article #}
    {% set other_posts = [] %}
    {% for post in posts %}
        {% if post != featured %}
            {% set other_posts = other_posts|merge([post]) %}
        {% endif %}
    {% endfor %}
    
    {% if other_posts|length > 0 %}
        <h2 class="section-title">Viimased artiklid</h2>
        <div class="post-grid">
            {% for post in other_posts|slice(0, 5) %}
                <article class="card">
                    {% if post.header.image %}
                        <a href="{{ post.url }}" class="card-image-link">
                            <img src="{{ post.media[post.header.image].url }}" alt="{{ post.title }}" class="card-image">
                        </a>
                    {% else %}
                        <a href="{{ post.url }}" class="card-image-link card-placeholder">
                            <span class="placeholder-icon">❦</span>
                        </a>
                    {% endif %}
                    
                    <div class="card-content">
                        <div class="card-category">
                            {% for tag in post.taxonomy.tag %}
                                <a href="{{ base_url }}/blog/tag:{{ tag }}">{{ tag }}</a>{% if not loop.last %}, {% endif %}
                            {% else %}
                                Uudised
                            {% endfor %}
                        </div>
                        <h3 class="card-title">
                            <a href="{{ post.url }}">{{ post.title }}</a>
                        </h3>
                        <div class="card-excerpt {{ post.title|length < 50 ? 'excerpt-long' : '' }}">
                            {% if post.title|length < 50 %}
                                {{ post.content|striptags|truncate(280, true, ' ...')|raw }}
                            {% else %}
                                {{ post.summary|striptags }}
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            {% set months = ["jaanuar", "veebruar", "märts", "aprill", "mai", "juuni", "juuli", "august", "september", "oktoober", "november", "detsember"] %}
                            <span class="card-date">{{ post.date|date("j.") }} {{ months[post.date|date("n") - 1] }} {{ post.date|date("Y") }}</span>
                            {% if post.taxonomy.author is iterable %}
                                {% set author = post.taxonomy.author|first %}
                            {% elseif post.header.taxonomy.author %}
                                {% set author = post.header.taxonomy.author|first %}
                            {% else %}
                                {% set author = post.header.author %}
                            {% endif %}
                            {% if author %}
                                <span class="card-author">
                                    <a href="{{ base_url }}/blog/author:{{ author|url_encode }}">{{ author }}</a>
                                </span>
                            {% endif %}
                        </div>
                        <a href="{{ post.url }}" class="read-more-link">Loe edasi →</a>
                    </div>
                </article>
            {% endfor %}
        </div>
        
        <div class="view-more">
            <a href="{{ base_url }}/blog" class="view-more-link">Vaata kõiki artikleid →</a>
        </div>
    {% endif %}
    {% endif %}
{% endblock %}
